#!/usr/bin/env bash
#MISE description="Generate editorialized release notes with Claude Code"
#USAGE arg "<version>" help="Git tag/version to generate notes for"
#USAGE arg "<output_dir>" help="Directory to write title and notes files"
#USAGE arg "[prev_version]" help="Previous version"
set -euo pipefail

version="${usage_version}"
output_dir="${usage_output_dir}"
prev_version="${usage_prev_version:-}"

mkdir -p "$output_dir"

# Get the git-cliff changelog for context
if [[ -n $prev_version ]]; then
	changelog=$(git cliff --strip all "${prev_version}..${version}" 2>/dev/null || echo "")
else
	changelog=$(git cliff --unreleased --strip all 2>/dev/null || echo "")
fi

if [[ -z $changelog ]]; then
	echo "Error: No changes found for release" >&2
	exit 1
fi

# Build prompt safely using printf to avoid command substitution on backticks in changelog
prompt=$(
	printf '%s\n' "You are writing release notes for fnox version ${version}${prev_version:+ (previous version: ${prev_version})}."
	printf '\n'
	printf '%s\n' "fnox is a secrets management CLI that encrypts and manages secrets in config files, supporting multiple providers (1Password, AWS, Azure, GCP, Bitwarden, etc.)."
	printf '\n'
	printf '%s\n' "Here is the raw changelog from git-cliff:"
	printf '%s\n' "$changelog"
	printf '\n'
	cat <<INSTRUCTIONS
Write user-friendly release notes with a creative title.

FORMAT - Your output MUST start with this exact line format:
# $version - <Creative Title>

Where <Creative Title> is 2-6 words capturing the theme of the release (e.g., "Secrets Stay Secret", "Provider Paradise", "Better Error Messages").
For smaller or less impactful releases, keep the title understated and modest.

TONE CALIBRATION:
- Match the tone and length to the actual significance of the changes
- If the release is mostly small bug fixes or minor tweaks, be upfront about thatâ€”a sentence or two of summary is fine, don't write multiple paragraphs inflating the importance
- Reserve enthusiastic, detailed write-ups for releases with genuinely significant features or changes
- It's okay to say "This is a smaller release focused on bug fixes" when that's the case

After the title line, write the release notes:
1. Start with a summary proportional to the significance of the changes
2. Organize into ### sections (Highlights, Bug Fixes, etc.)
3. Explain WHY changes matter to users
4. Include PR links and documentation links (https://fnox.jdx.dev/)
5. Include contributor usernames (@username). Do not thank @jdx since that is who is writing these notes.
6. Skip internal changes
INSTRUCTIONS
)

# Use Claude Code to generate the release notes
echo "Generating release notes with Claude..." >&2
echo "Version: $version" >&2
echo "Previous version: ${prev_version:-none}" >&2
echo "Changelog length: ${#changelog} chars" >&2

if ! output=$(
	printf '%s' "$prompt" | claude -p \
		--model claude-opus-4-6 \
		--permission-mode bypassPermissions \
		--output-format text \
		--allowedTools "Read,Grep,Glob"
); then
	echo "Error: Claude CLI failed" >&2
	exit 1
fi

# Validate we got non-empty output
if [[ -z $output ]]; then
	echo "Error: Claude returned empty output" >&2
	exit 1
fi

# Strip any preamble before the "# vX.X.X -" line
output=$(printf '%s\n' "$output" | sed -n '/^# v[0-9]/,$p')

if [[ -z $output ]]; then
	echo "Error: No '# vX.X.X -' line found in Claude output" >&2
	exit 1
fi

echo "Raw output:" >&2
printf '%s\n' "$output" >&2

# Extract title from first line (format: "# vX.X.X - Creative Title")
title=$(printf '%s\n' "$output" | head -1 | sed 's/^# //')
body=$(printf '%s\n' "$output" | tail -n +2)

# Write parsed results to output directory
printf '%s\n' "$title" >"$output_dir/title"
printf '%s\n' "$body" >"$output_dir/notes"
echo "Wrote title and notes to $output_dir"
