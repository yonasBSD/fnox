#!/usr/bin/env bash
#MISE description="Generate concise changelog entry using Claude Code"
#USAGE arg "<version>" help="Version to release (e.g., v1.9.0)"
#USAGE arg "[prev_version]" help="Previous version for comparison"
set -euo pipefail

version="${usage_version:-}"
prev_version="${usage_prev_version:-}"

if [[ -z $version ]]; then
	echo "Usage: mise run gen-release-summary <version> [prev_version]" >&2
	exit 1
fi

# Get the git-cliff changelog for context
changelog=$(git cliff --unreleased --strip all 2>/dev/null || echo "")

if [[ -z $changelog ]]; then
	echo "Error: No unreleased changes found" >&2
	exit 1
fi

# Build prompt safely using printf to avoid command substitution on backticks in changelog
prompt=$(
	printf '%s\n' "You are writing release notes for fnox version ${version}${prev_version:+ (previous version: ${prev_version})}."
	printf '\n'
	printf '%s\n' "fnox is a secrets management CLI that encrypts and manages secrets in config files, supporting multiple providers (1Password, AWS, Azure, GCP, Bitwarden, etc.)."
	printf '\n'
	printf '%s\n' "Here is the raw changelog from git-cliff:"
	printf '%s\n' "$changelog"
	printf '\n'
	cat <<'INSTRUCTIONS'
Write a brief changelog entry:

1. One short paragraph (2-3 sentences) summarizing the release
2. Categorized bullet points (### Features, ### Bug Fixes, etc.)
3. One line per change, no explanations
4. Skip minor/internal changes
5. Include PR links for significant changes
6. Include contributor usernames (@username)
7. Link to relevant documentation at https://fnox.jdx.dev/ where applicable

IMPORTANT: Use only ### for section headers. NEVER use "## [" as this pattern is reserved for version headers.

Output ONLY the brief changelog, no preamble.
INSTRUCTIONS
)

# Use Claude Code to generate the changelog entry
# Sandboxed: only read-only tools allowed (no Bash, Edit, Write)
output=$(
	printf '%s' "$prompt" | claude -p \
		--model claude-opus-4-20250514 \
		--output-format text \
		--allowedTools "Read,Grep,Glob"
)

# Validate output doesn't contain patterns that would corrupt changelog processing
if echo "$output" | grep -qE '^## \['; then
	echo "Error: LLM output contains '## [' pattern which would corrupt changelog processing" >&2
	exit 1
fi

echo "$output"
